package com.github.digdeep126;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.InetSocketAddress;
import java.net.Socket;

import javax.xml.bind.DatatypeConverter;

import com.alibaba.fastjson.JSON;
import com.github.digdeep126.packet.CommandPacket;
import com.github.digdeep126.packet.HandShakeResponse;
import com.github.digdeep126.packet.OKPacket;
import com.github.digdeep126.packet.ServerHandShake;
import com.github.digdeep126.util.ByteUtil;
import com.github.digdeep126.util.ByteWriteUtil;

@SuppressWarnings("restriction")
public class Test2 {
	
	public static void main(String[] args){
		InetSocketAddress serverAddr = new InetSocketAddress("192.168.1.3", 3306);
		
        try (Socket client = new Socket();){
        	client.connect(serverAddr, 1000*10);
        	InputStream in = client.getInputStream();

        	int readLen = 0;
            byte[] buff = new byte[1024*16];
            readLen = in.read(buff);
            System.out.println("readLen:" + readLen);
            
			String hex = DatatypeConverter.printHexBinary(buff);
//    		System.out.println(hex);
    		byte[] bin = DatatypeConverter.parseHexBinary(hex);
//    		System.out.println(new String(bin));
    		
    		ServerHandShake serverHandShake = new ServerHandShake(buff);
    		System.out.println(JSON.toJSON(serverHandShake));
    		
    		HandShakeResponse response = new HandShakeResponse(serverHandShake);
    		byte[] result = response.createAuthPackage();
    		System.out.println("result.length: " + result.length);	// 64
    		hex = DatatypeConverter.printHexBinary(result);
    		System.out.println("result: " + hex);
//    		
    		OutputStream os = client.getOutputStream();
    		os.write(result, 0, result.length);
    		
    		//===============================
    		
    		CommandPacket packet = new CommandPacket();
    		packet.packetSequenceId = 1;
    		packet.command = 3;
    		packet.arg = "select 1".getBytes("utf8");
    		
    		byte[] buffer = new byte[13];
    		int size = 1 + packet.arg.length;
    		System.out.println("size:::::::::" + size);	// 9
    		ByteWriteUtil.writeUB3(buffer, 0, size);
    		ByteWriteUtil.writeUB1(buffer, 3, packet.packetSequenceId);	// sequenceId
    		ByteWriteUtil.writeUB1(buffer, 4, packet.command);	// command
    		System.arraycopy(packet.arg, 0, buffer, 5, packet.arg.length);
    		
    		os = client.getOutputStream();
    		
    		os.write(buffer, 0, buffer.length);
    		os.flush();
//    		result = response.createAuthPackage();
//    		os.write(result, 0, result.length);
    		
    		in = client.getInputStream();
            readLen = in.read(buff);
            System.out.println("readLen3:" + readLen);
            
 			hex = DatatypeConverter.printHexBinary(buff);
 			bin = DatatypeConverter.parseHexBinary(hex);
    		System.out.println("............" + new String(bin));	// 08S01Bad handshake+ KEWf{X&SOroW mysql_native_password
    		
    		int header = buffer[4];
    		System.out.println("............header " + header);
    		int error_code = ByteUtil.readUB2(buffer, 5);
    		System.out.println("............error_code " + error_code);

    		//    		int<1>	header	[ff] header of the ERR packet
//    		int<2>	error_code	error-code
//    		if capabilities & CLIENT_PROTOCOL_41 {
//    		string[1]	sql_state_marker	# marker of the SQL State
//    		string[5]	sql_state	SQL State
//    		}
//    		string<EOF>	error_message	human readable error messag
    		// 08S01 Got packets out of order ?[/sy)\sMg@G mysql_native_password
//    		Error: 1156 SQLSTATE: 08S01 (ER_NET_PACKETS_OUT_OF_ORDER) Message: Got packets out of order 
 			//=============================== 
    		
    		
    		
    		
//    		readLen = 0;
//            buff = new byte[1024*16];
//            readLen = in.read(buff);
//            System.out.println("readLen2:" + readLen);
//            
//			hex = DatatypeConverter.printHexBinary(buff);
//    		System.out.println(hex);
//    		bin = DatatypeConverter.parseHexBinary(hex);
//    		System.out.println("............" + new String(bin));
    		
//    		int flag = buff[4];
//    		if(flag == 0){
//    			OKPacket okPackage = new OKPacket(buff);
//        		System.out.println("okPackage:" + JSON.toJSON(okPackage));
//        		byte[] re = new byte[11];
//        		System.arraycopy(buff, 0, re, 0, 11);
//        		hex = DatatypeConverter.printHexBinary(re);
////              len    id  header aff last status  warn		
////        		070000 02  00     00   00  0200    0000
//        		System.out.println("re::::::::::" + hex);
//        		bin = DatatypeConverter.parseHexBinary(hex);
//        		System.out.println("++++++++++:" + new String(bin));
        		
//        		COM_QUERY:
//    			A COM_QUERY is used to send the server a text-based query that is executed immediately.
//    			The server replies to a COM_QUERY packet with a COM_QUERY Response.
//    			The length of the query-string is a taken from the packet length - 1.
//    			Payload
//    			1              [03] COM_QUERY
//    			string[EOF]    the query the server shall execute
//    			Fields
//    			command_id (1) -- 0x03 COM_QUERY
//    			query (string.EOF) -- query_text
//        		CommandPacket packet = new CommandPacket();
//        		packet.packetId = 3;
//        		packet.command = 3;
//        		packet.arg = "select 1".getBytes("utf8");
//        		
//        		byte[] buffer = new byte[13];
//        		int size = 1 + packet.arg.length;
//        		System.out.println("size:::::::::" + size);	// 9
//        		ByteWriteUtil.writeUB3(buffer, 0, size);
//        		ByteWriteUtil.writeUB1(buffer, 3, packet.packetId);	// sequenceId
//        		ByteWriteUtil.writeUB1(buffer, 4, packet.command);	// command
//        		System.arraycopy(packet.arg, 0, buffer, 5, packet.arg.length);
//        		
//        		os = client.getOutputStream();
//        		
//        		os.write(buffer, 0, buffer.length);
//        		os.flush();
////        		result = response.createAuthPackage();
////        		os.write(result, 0, result.length);
//        		
//        		in = client.getInputStream();
//        		System.out.println("555555555555" );
//                readLen = in.read(buff);
//                System.out.println("readLen3:" + readLen);
//                System.out.println("66666666666666" );
//                 
//     			hex = DatatypeConverter.printHexBinary(buff);
////     			3C0000 01 FF 8104233038533031476F742061207061636B657420626967676572207468616E20276D61785F616C6C6F7765645F7061636B657427206279746573000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
//         		
//     			System.out.println(hex);
//         		bin = DatatypeConverter.parseHexBinary(hex);
//         		
//         		//++++++++++:<#08S01Got a packet bigger than 'max_allowed_packet' bytes
//         		System.out.println("++++++++++:" + new String(bin));
//    		}
    		
    		
//    		byte[] query = new byte[39];
//    		int offset = 0;
//    		offset += 3;
//    		ByteWriteUtil.writeUB1(query, offset, 3);	// sequenceId
//    		offset += 1;
//    		
//    		ByteWriteUtil.writeUB1(query, offset, 0x03);	// [03] COM_QUERY
//    		offset += 1;
//    		
////    		If a string is the last component of a packet, 
////    		its length can be calculated from the overall packet length minus the current position.
//    		
//    		String SQL = "select * from mysql.user";					// query (string.EOF) -- query_text
//    		
//    		System.arraycopy(SQL.getBytes(), 0, query, offset, SQL.getBytes().length);
//    		query[offset++] = 0;
////    		ByteWriteUtil.writeBytesWithNULL(query, offset, SQL.getBytes());
//    		offset += SQL.getBytes().length+1;
//    		ByteWriteUtil.writeUB3(query, 0, offset-4);
//    		
//    		System.out.println("offset:" + offset );
//    		
////    		query = new byte(){0x21, 0x00, 0x00, 0x00, 0x03, 0x73, 0x65, 0x6c,0x65, 0x63 ,0x74, 0x20, 0x40 ,0x40, 0x76 ,0x65,
////    			0x72, 0x73, 0x69, 0x6f, 0x6e, 0x5f, 0x63, 0x6f,    
////    			0x6d, 0x6d, 0x65, 0x6e, 0x74, 0x20, 0x6c, 0x69,0x6d, 0x69, 0x74, 0x20, 0x31
////    		};
//    		query = new byte[37];
//    		
//    		ByteWriteUtil.writeUB1(query, 0, 0x21);
//    		ByteWriteUtil.writeUB1(query, 1, 0x00);
//    		ByteWriteUtil.writeUB1(query, 2, 0x00);
//    		ByteWriteUtil.writeUB1(query, 3, 0x00);
//    		ByteWriteUtil.writeUB1(query, 4, 0x03);
//    		ByteWriteUtil.writeUB1(query, 5, 0x73);
//    		ByteWriteUtil.writeUB1(query, 6, 0x65);
//    		ByteWriteUtil.writeUB1(query, 7, 0x6c);
//    		ByteWriteUtil.writeUB1(query, 8, 0x65);
//    		ByteWriteUtil.writeUB1(query, 9, 0x63);
//    		ByteWriteUtil.writeUB1(query, 10, 0x74);
//    		ByteWriteUtil.writeUB1(query, 11, 0x20);
//    		ByteWriteUtil.writeUB1(query, 12, 0x40);
//    		ByteWriteUtil.writeUB1(query, 13, 0x40);
//    		ByteWriteUtil.writeUB1(query, 14, 0x76);
//    		ByteWriteUtil.writeUB1(query, 15, 0x65);
//    		ByteWriteUtil.writeUB1(query, 16, 0x72);
//    		ByteWriteUtil.writeUB1(query, 17, 0x73);
//    		ByteWriteUtil.writeUB1(query, 18, 0x69);
//    		ByteWriteUtil.writeUB1(query, 19, 0x6f);
//    		ByteWriteUtil.writeUB1(query, 20, 0x6e);
//    		ByteWriteUtil.writeUB1(query, 21, 0x5f);
//    		ByteWriteUtil.writeUB1(query, 22, 0x63);
//    		ByteWriteUtil.writeUB1(query, 23, 0x6f);
//    		ByteWriteUtil.writeUB1(query, 24, 0x6d);
//    		ByteWriteUtil.writeUB1(query, 25, 0x6d);
//    		ByteWriteUtil.writeUB1(query, 26, 0x65);
//    		ByteWriteUtil.writeUB1(query, 27, 0x6e);
//    		ByteWriteUtil.writeUB1(query, 28, 0x74);
////    		0x20, 0x6c, 0x69, 0x6d, 0x69, 0x74, 0x20, 0x31
//    		ByteWriteUtil.writeUB1(query, 29, 0x20);
//    		ByteWriteUtil.writeUB1(query, 30, 0x6c);
//    		ByteWriteUtil.writeUB1(query, 31, 0x69);
//    		ByteWriteUtil.writeUB1(query, 32, 0x6d);
//    		ByteWriteUtil.writeUB1(query, 33, 0x69);
//    		ByteWriteUtil.writeUB1(query, 34, 0x74);
//    		ByteWriteUtil.writeUB1(query, 35, 0x20);
//    		ByteWriteUtil.writeUB1(query, 36, 0x31);
//    		
////    		05 00 00 00 02 74 65 73    74 
//    		query = new byte[17];
//    		ByteWriteUtil.writeUB1(query, 0, 0x05);
//    		ByteWriteUtil.writeUB1(query, 1, 0x00);
//    		ByteWriteUtil.writeUB1(query, 2, 0x00);
//    		ByteWriteUtil.writeUB1(query, 3, 0x00);
//    		ByteWriteUtil.writeUB1(query, 4, 0x02);
//    		ByteWriteUtil.writeUB1(query, 4, 0x74);
//    		ByteWriteUtil.writeUB1(query, 4, 0x65);
//    		ByteWriteUtil.writeUB1(query, 4, 0x73);
//    		ByteWriteUtil.writeUB1(query, 4, 0x74);
//    		
//    		
////    		offset += 1;
//    		
////    		1              [01] COM_QUIT
////    		01 00 00 00 01
//    		query = new byte[17];
//    		ByteWriteUtil.writeUB1(query, 0, 0x01);
//    		ByteWriteUtil.writeUB1(query, 1, 0x00);
//    		ByteWriteUtil.writeUB1(query, 2, 0x00);
//    		ByteWriteUtil.writeUB1(query, 3, 0x03);
//    		ByteWriteUtil.writeUB1(query, 4, 0x01);
//    		
//    		
////    		protected void sendQueryCmd(String query) {
////    			CommandPacket packet = new CommandPacket();
////    			packet.packetId = 0;
////    			packet.command = MySQLPacket.COM_QUERY;
////    			try {
////    				packet.arg = query.getBytes(charset);
////    			} catch (UnsupportedEncodingException e) {
////    				throw new RuntimeException(e);
////    			}
////    			lastTime = TimeUtil.currentTimeMillis();
////    			packet.write(this);	// 利用 MySQLBackendConnection 向 mysqld 发送 CommandPacket
////    		}
//    		CommandPacket packet = new CommandPacket();
//    		packet.packetId = 0;
//    		packet.command = 3;
//    		packet.arg = "select 1".getBytes("utf8");
//    		
//    		byte[] buffer = new byte[13];
//    		int size = 1 + packet.arg.length;
//    		System.out.println("size:::::::::" + size);	// 9
//    		ByteWriteUtil.writeUB3(buffer, 0, size);
//    		ByteWriteUtil.writeUB1(buffer, 3, packet.packetId);	// sequenceId
//    		ByteWriteUtil.writeUB1(buffer, 4, packet.command);	// command
//    		System.arraycopy(packet.arg, 0, buffer, 5, packet.arg.length);
//    		
//    		os = client.getOutputStream();
//    		
//    		os.write(buffer, 0, buffer.length);
////    		ByteWriteUtil.writeWithLength(buffer, 5, packet.arg);
//    		
//    		
////    		BufferUtil.writeUB3(buffer, size);
////			buffer.put(packetId);
////			buffer.put(command);
////			buffer.put(arg);
//    		
////    		System.arraycopy(packet.arg, 0, query, 5, packet.arg.length);
//    		hex = DatatypeConverter.printHexBinary(buffer);
////    		length id command select 1
////    		090000 00 03      73656C656374203100
////    		090000 00 03      73656C6563742031
//    		System.out.println(hex);
//    		bin = DatatypeConverter.parseHexBinary(hex);
//    		System.out.println("++++++++++:" + new String(bin));
//    		
//    		
////    		ByteWriteUtil.writeWithLength(query, 5, packet.arg);
//    		
////    		os.write(query, 0, query.length);
//    		
////    		public void write(Connection conn) {
////    			int size = calcPacketSize();
////    			int totalSize = size + packetHeaderSize;
////    			if (NetSystem.getInstance().getBufferPool().getChunkSize() >= totalSize) {
////    				ByteBuffer buffer = NetSystem.getInstance().getBufferPool().allocate();
////    				BufferUtil.writeUB3(buffer, size);
////    				buffer.put(packetId);
////    				buffer.put(command);
////    				buffer.put(arg);
////    				conn.write(buffer);
////    			} else {
////    				BufferArray bufArray = NetSystem.getInstance().getBufferPool().allocateArray();
////    				write(bufArray);
////    				conn.write(bufArray);
////    			}
////    		}
//    		
//    		readLen = 0;
//            buff = new byte[1024*16];
//            
//            System.out.println("344444444444" );
//            in = client.getInputStream();
//            readLen = in.read(buff);
//            System.out.println("66666666666666" );
//            System.out.println("readLen3:" + readLen);
//            
//			hex = DatatypeConverter.printHexBinary(buff);
//    		System.out.println(hex);
//    		bin = DatatypeConverter.parseHexBinary(hex);
//    		System.out.println("++++++++++:" + new String(bin));
//    		
//    		
//    		flag = buff[4];
////    		if(flag == 0xff){
//    			int errorCode = ByteUtil.readUB2(buff, 5);
//    			System.out.println("errorCode:" + errorCode);
//    			
//    			int sql_state_marker = buff[6];
//    			System.out.println("sql_state_marker:" + sql_state_marker);
//    			
//    			
//    			byte[] sql = new byte[5];
//    			System.arraycopy(buff, 7, sql, 0, 5);
//    			String sqlState = new String(sql);
//    			System.out.println("sqlState:" + sqlState);
//    			
//    			byte[] err = new byte[90];
//    			System.arraycopy(buff, 13, err, 0, 90);
//    			String errorMsg = new String(err);
//    			System.out.println("errorMsg:" + errorMsg);
////    		}
    		
//        case ErrorPacket.FIELD_COUNT:
//			ErrorPacket err = new ErrorPacket();
//			err.read(data);
//			String errMsg = new String(err.message);
//			LOGGER.warn("can't connect to mysql server ,errmsg:" + errMsg + " " + source);
//			// source.close(errMsg);
//			throw new ConnectionException(err.errno, errMsg);
//    		14.1.3.2 ERR_Packet
//
//    		This packet signals that an error occurred. It contains a SQL state value if CLIENT_PROTOCOL_41 is enabled.
//
//    		Payload
//
//    		Type	Name	Description
//    		int<1>	header	[ff] header of the ERR packet
//    		int<2>	error_code	error-code
//    		if capabilities & CLIENT_PROTOCOL_41 {
//    		string[1]	sql_state_marker	# marker of the SQL State
//    		string[5]	sql_state	SQL State
//    		}
//    		string<EOF>	error_message	human readable error message

		} catch (IOException e) {
			e.printStackTrace();
		}
	}
	
//	Protocol::HandshakeV9:
//		Initial Handshake Packet - Protocol Version 9
//		Payload
//		1              [09] protocol_version
//		string[NUL]    server_version
//		4              connection_id
//		string[NUL]    scramble
	
//		Fields
//		protocol_version (1) -- 0x09 protocol_version
//		server_version (string.NUL) -- human-readable server version
//		connection_id (4) -- connection id
//		auth_plugin_data (string.NUL) -- auth plugin data for Authentication::Old
}
